---
import { getCollection } from 'astro:content';

const { activeTag, currentSlug } = Astro.props;

const allEntries = await getCollection('entries');
const sortedEntries = allEntries.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Get all unique tags with counts
const tagCounts = allEntries.reduce((acc, entry) => {
  entry.data.tags.forEach(tag => {
    acc[tag] = (acc[tag] || 0) + 1;
  });
  return acc;
}, {});
const allTags = Object.keys(tagCounts).sort();

// Filter entries if a tag is active
const displayedEntries = activeTag 
  ? sortedEntries.filter(entry => entry.data.tags.includes(activeTag))
  : sortedEntries;

// Show only recent entries in sidebar (max 5)
const recentEntries = sortedEntries.slice(0, 5);
---

<aside class="w-full md:w-64 md:h-screen bg-sozna-sidebar border-r border-zinc-800 flex flex-col md:fixed md:left-0 md:top-0 overflow-y-auto z-10">
  <div class="p-6">
    <a href="/Open-Sozna-research/" class="block">
      <h1 class="font-sans text-xl font-bold text-sozna-heading tracking-tight hover:text-sozna-accent transition-colors">
        Open Sozna<br/>Research
      </h1>
    </a>
    <p class="mt-2 text-xs text-zinc-500 font-sans">A living theory of mind.</p>
  </div>

  <nav class="flex-1 px-4 pb-6">
    {/* Tags Section */}
    <div class="mb-8">
      <h2 class="text-xs font-bold text-zinc-500 uppercase tracking-wider mb-3">Filter by Tag</h2>
      <div class="flex flex-wrap gap-2">
        <a 
          href="/Open-Sozna-research/entries" 
          class={`text-xs px-2 py-1 rounded transition-colors ${!activeTag ? 'bg-sozna-accent text-zinc-900 font-medium' : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700'}`}
        >
          All ({allEntries.length})
        </a>
        {allTags.map(tag => (
          <a 
            href={`/Open-Sozna-research/tags/${tag}`}
            class={`text-xs px-2 py-1 rounded transition-colors ${activeTag === tag ? 'bg-sozna-accent text-zinc-900 font-medium' : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700'}`}
          >
            {tag} ({tagCounts[tag]})
          </a>
        ))}
      </div>
    </div>

    {/* Entries List */}
    <div>
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xs font-bold text-zinc-500 uppercase tracking-wider">
          {activeTag ? `${activeTag} Entries` : 'Recent Entries'}
        </h2>
        {!activeTag && (
          <a href="/Open-Sozna-research/entries" class="text-xs text-zinc-600 hover:text-sozna-accent transition-colors">
            View all â†’
          </a>
        )}
      </div>
      <ul class="space-y-3">
        {(activeTag ? displayedEntries : recentEntries).map(entry => (
          <li>
            <a 
              href={activeTag ? `/Open-Sozna-research/tags/${activeTag}/${entry.slug}` : `/Open-Sozna-research/entries/${entry.slug}`} 
              class={`block group ${currentSlug === entry.slug ? 'opacity-100' : 'opacity-90 hover:opacity-100'}`}
            >
              <span class={`block text-sm font-medium transition-colors ${currentSlug === entry.slug ? 'text-sozna-accent' : 'text-sozna-text group-hover:text-sozna-heading'}`}>
                {entry.data.title}
              </span>
              <span class="block text-xs text-zinc-400 mt-0.5 font-sans">
                {entry.data.date.toISOString().split('T')[0]}
              </span>
            </a>
          </li>
        ))}
        {displayedEntries.length === 0 && (
          <li class="text-xs text-zinc-500 italic">No entries found.</li>
        )}
      </ul>
    </div>
  </nav>

  {/* Newsletter */}
  <div class="px-4 py-4 border-t border-zinc-800">
    <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-wider mb-3">Newsletter</h3>
    <p class="text-xs text-zinc-400 mb-3">New entries in your inbox.</p>
    <form action="https://api.follow.it/subscription-form/UUlXOFozSGVLSmdvNXB0RXZzQVhySU42emZ2M3BhVlg2VmJrWXNDUlNNQTlWRll5THFjaVVLVU1MZDFwbEkyZGhUbU1PWk9WOS81aEJJMUJKOEE1SkZQYUplb0tSbXFNbk1SZFM4NWxRRjgzYi96SXFXOEREa0hacjV4UlhWcVN8aHVXNFllUitlazRoYWdFaUtKSC9HUnJzUUorQldBOVVmQXdzTCtIWktLYz0=/8" method="post" class="space-y-2">
      <input 
        type="email" 
        name="email" 
        required 
        placeholder="Enter your email" 
        class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded text-sm text-sozna-text placeholder-zinc-500 focus:outline-none focus:border-sozna-accent"
      />
      <button 
        type="submit" 
        class="w-full px-4 py-2 bg-sozna-accent text-zinc-900 text-sm font-medium rounded hover:bg-opacity-90 transition-colors font-sans"
      >
        Subscribe
      </button>
    </form>
  </div>

  {/* Footer Links */}
  <div class="px-4 pb-6 pt-4 border-t border-zinc-800">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="/Open-Sozna-research/about" class="text-sm text-sozna-text hover:text-sozna-accent transition-colors font-sans">
          About
        </a>
        <span class="text-zinc-700">|</span>
        <a href="/Open-Sozna-research/rss.xml" class="flex items-center gap-1.5 text-sm text-sozna-text hover:text-sozna-accent transition-colors font-sans" title="RSS Feed">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="M5 3a1 1 0 000 2c5.523 0 10 4.477 10 10a1 1 0 102 0C17 8.373 11.627 3 5 3z" />
            <path d="M4 9a1 1 0 011-1 7 1 0 017 7 1 1 0 11-2 0 5 1 0 00-5-5 1 1 0 01-1-1zM3 15a2 2 0 114 0 2 2 0 01-4 0z" />
          </svg>
          RSS
        </a>
      </div>
    </div>
  </div>
</aside>
