---
import { getCollection, getEntry, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { marked } from 'marked';

export async function getStaticPaths() {
  const allEntries = await getCollection('entries');
  const allTags = [...new Set(allEntries.flatMap(entry => entry.data.tags))];
  
  return allTags.map(tag => {
    const entries = allEntries.filter(entry => entry.data.tags.includes(tag));
    const sortedEntries = entries.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
    const latestEntry = sortedEntries[0];
    return {
      params: { tag },
      props: { 
        tag,
        entry: latestEntry,
        entries: sortedEntries
      },
    };
  });
}

const { tag, entry, entries } = Astro.props;

// Get all concepts
const allConcepts = await getCollection('concepts');
const conceptRenderMap = new Map();

for (const concept of allConcepts) {
  const { Content } = await render(concept);
  conceptRenderMap.set(concept.slug, { title: concept.data.title, Content });
}

// Parse content with concepts
const rawContent = entry.body;
const conceptRegex = /:::\s*concept\s*\{\s*name\s*=\s*["']([^"']+)["']\s*\}\s*:::/g;

const segments = [];
let lastIndex = 0;
let match;

while ((match = conceptRegex.exec(rawContent)) !== null) {
  if (match.index > lastIndex) {
    const textContent = rawContent.slice(lastIndex, match.index);
    const html = marked.parse(textContent);
    segments.push({ type: 'html', content: html });
  }
  
  segments.push({ type: 'concept', name: match[1] });
  lastIndex = conceptRegex.lastIndex;
}

if (lastIndex < rawContent.length) {
  const textContent = rawContent.slice(lastIndex);
  const html = marked.parse(textContent);
  segments.push({ type: 'html', content: html });
}

// Navigation logic for tag context
const nextEntry = null;
const prevEntry = entries.length > 1 ? entries[1] : null;
---

<Layout title={`${tag} | ${entry.data.title}`} currentSlug={entry.slug} activeTag={tag}>
  <header class="mb-12">
    <div class="flex items-center gap-4 text-xs font-sans text-zinc-500 mb-6 uppercase tracking-wider">
      <time datetime={entry.data.date.toISOString()}>
        {entry.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
      </time>
      <div class="flex gap-2">
        {entry.data.tags.map(t => (
          <a href={`/Open-Sozna-research/tags/${t}`} class={`px-2 py-0.5 rounded transition-colors ${t === tag ? 'bg-sozna-accent text-zinc-900 font-medium' : 'bg-zinc-800 text-zinc-400 hover:text-white'}`}>
            {t}
          </a>
        ))}
      </div>
    </div>
    
    <h1 class="text-4xl md:text-5xl font-sans font-bold text-sozna-heading leading-tight mb-4">
      {entry.data.title}
    </h1>
    
    {entry.data.subtitle && (
      <p class="text-xl md:text-2xl font-serif text-zinc-400 italic font-light leading-relaxed">
        {entry.data.subtitle}
      </p>
    )}
  </header>

  <article class="prose prose-invert prose-lg max-w-none font-serif">
    {segments.map((segment) => {
      if (segment.type === 'html') {
        return <Fragment set:html={segment.content} />;
      }
      
      if (segment.type === 'concept') {
        const concept = conceptRenderMap.get(segment.name);
        if (!concept) {
          return (
            <div class="my-4 p-4 border border-red-700/50 rounded bg-red-900/20 text-red-400 text-sm">
              Concept "{segment.name}" not found
            </div>
          );
        }
        
        const ConceptContent = concept.Content;
        return (
          <details class="concept-dropdown my-6 group border border-zinc-700/50 rounded-md p-3 bg-zinc-800/30">
            <summary class="concept-summary cursor-pointer list-none">
              <span class="concept-label inline-flex items-center gap-2 text-sozna-accent hover:text-opacity-80 transition-colors font-medium">
                <svg 
                  xmlns="http://www.w3.org/2000/svg" 
                  class="concept-icon w-4 h-4 transition-transform duration-200 group-open:rotate-90" 
                  viewBox="0 0 20 20" 
                  fill="currentColor"
                >
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
                {concept.title}
              </span>
            </summary>
            <div class="concept-content mt-3 pl-6 border-l-2 border-zinc-700 text-zinc-300">
              <div class="prose prose-invert prose-sm max-w-none">
                <ConceptContent />
              </div>
            </div>
          </details>
        );
      }
      
      return null;
    })}
  </article>

  {/* Reactions */}
  <div class="mt-12 pt-8 border-t border-zinc-800/50">
    <div class="flex items-center gap-6">
      <span class="text-xs font-sans text-zinc-500 uppercase tracking-wider">React</span>
      <div class="flex items-center gap-3">
        <lyket-widget namespace="open-sozna" id={`${entry.slug}-fire`} template="like">
          <button class="text-2xl hover:scale-110 transition-transform" title="Resonates">ðŸ”¥</button>
        </lyket-widget>
        <lyket-widget namespace="open-sozna" id={`${entry.slug}-thinking`} template="like">
          <button class="text-2xl hover:scale-110 transition-transform" title="Need more">ðŸ¤”</button>
        </lyket-widget>
        <lyket-widget namespace="open-sozna" id={`${entry.slug}-learned`} template="like">
          <button class="text-2xl hover:scale-110 transition-transform" title="Learned something">ðŸ’¡</button>
        </lyket-widget>
      </div>
    </div>
  </div>

  {/* Feedback */}
  <div class="mt-6">
    <a href="https://tally.so/r/BzkOe1" class="text-xs text-zinc-500 hover:text-sozna-accent transition-colors font-sans">
      Have feedback? Tell me what was confusing or what to write next â†’
    </a>
  </div>

  <nav class="mt-16 pt-8 border-t border-zinc-800 flex justify-between text-sm font-sans">
    <div class="w-1/2 pr-4">
      {prevEntry && (
        <a href={`/Open-Sozna-research/tags/${tag}/${prevEntry.slug}`} class="text-zinc-500 hover:text-sozna-accent transition-colors flex flex-col items-start gap-1 group text-left">
          <span class="text-xs uppercase tracking-wider text-zinc-600 group-hover:text-sozna-accent">Previous in {tag}</span>
          <span class="font-medium line-clamp-1">{prevEntry.data.title}</span>
        </a>
      )}
    </div>
    
    <div class="w-1/2 pl-4 flex justify-end">
      {/* No newer entry */}
    </div>
  </nav>
</Layout>

<style>
  .concept-summary::-webkit-details-marker {
    display: none;
  }
  
  .concept-dropdown[open] .concept-icon {
    transform: rotate(90deg);
  }
</style>
