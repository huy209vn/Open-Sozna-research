name: Send Newsletter on New Entry

on:
  push:
    branches: [main]
    paths:
      - 'src/content/entries/**'

jobs:
  send-email:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Find new entries
        id: new-entries
        run: |
          # Get list of changed entry files
          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep "src/content/entries/" | grep "\.md$" || true)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send email for new entries
        if: steps.new-entries.outputs.changed_files != ''
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
        run: |
          for file in ${{ steps.new-entries.outputs.changed_files }}; do
            if [ -f "$file" ]; then
              # Extract title from frontmatter
              TITLE=$(grep "^title:" "$file" | head -1 | sed 's/title: "//;s/"$//')
              # Extract slug from filename
              SLUG=$(basename "$file" .md | sed 's/^[0-9]*-//')
              
              # Send email via Buttondown
              curl -X POST https://api.buttondown.email/v1/emails \
                -H "Authorization: Token $BUTTONDOWN_API_KEY" \
                -H "Content-Type: application/json" \
                -d "{
                  \"subject\": \"$TITLE\",
                  \"body\": \"<p>New entry from Open Sozna Research.</p><p><a href='https://huy209vn.github.io/Open-Sozna-research/entries/$SLUG'>Read online â†’</a></p>\",
                  \"status\": \"sent\"
                }"
            fi
          done
